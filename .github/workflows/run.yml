name: Run bakeoff on MacOS, Ubuntu, and Windows

on:
  workflow_dispatch:
  
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - uses: actions/checkout@v4
      
      # ---------------------------------------
      # Disable Windows Defender (Windows only)
      # ---------------------------------------
      - name: Disable Windows Defender
        if: startsWith(matrix.os, 'windows')
        shell: powershell
        run: |
           Set-MpPreference -DisableRealtimeMonitoring $true
           
     # ----------------------------
      # Install Nim
      # ----------------------------
      - name: Install Nim (POSIX)
        if: runner.os != 'Windows'
        run: |
          curl https://nim-lang.org/choosenim/init.sh -sSf | sh -s -- -y
          echo "$HOME/.nimble/bin" >> $GITHUB_PATH
      
      - name: Install Nim (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install nim -y
          
          # Find nim.exe dynamically
          $nimExe = Get-ChildItem C:\tools\Nim -Recurse -Filter "nim.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($nimExe) {
            $nimBinDir = $nimExe.Directory.FullName
            Write-Host "Found Nim at: $nimBinDir"
            echo $nimBinDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            Write-Host "ERROR: nim.exe not found!"
            exit 1
          }
        shell: powershell

      # ----------------------------
      # Install D compiler (ldc2)
      # ----------------------------
      - name: Install D (ldc2)
        uses: dlang-community/setup-dlang@v1
        with:
          compiler: ldc-latest

      # ----------------------------
      # Install Zig
      # ----------------------------
      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.2
          cache: false

      # ----------------------------
      # Install Go
      # ----------------------------
      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: latest
          cache: false
 
      # ----------------------------
      # Install Rust
      # ----------------------------
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          
      # ----------------------------
      # Setup Java
      # ----------------------------
      - name: Set up Hotspot JVM
        uses: actions/setup-java@v4
        env:
          NODE_NO_WARNINGS: 1
        with:
          distribution: 'oracle'
          java-version: '21'

      # ----------------------------
      # Verify Language Processors
      # ----------------------------
      - name: Verify Language Processors
        shell: bash
        run: |
          echo "=== Compilers ==="
          echo "OS: $RUNNER_OS"
          echo "Arch: $(uname -m)"
          echo "GCC:"
          gcc --version | head -n 1 || echo "gcc not available"
          echo "D \(LDC2\):"
          ldc2 --version 2>&1 | grep -m1 "LDC" || echo "ldc2 not available"
          echo "Go:"
          go version
          echo "Nim:"
          nim --version
          echo "Python:"
          python3 --version
          echo "Rust:"
          rustc --version
          echo "Java:"
          java -version 2>&1 | head -n 1
          echo "Zig:"
          zig version

      # -----------------------------
      # Run bash script: run.sh
      # Generate: run.log and run.csv
      # -----------------------------
      - name: Compile and Execute
        shell: bash
        run: |
          chmod +x ./run.sh
          ./run.sh

      # ----------------------------
      # Upload log
      # ----------------------------
      - name: Upload log
        uses: actions/upload-artifact@v4
        with:
          name: run-log-${{ matrix.os }}
          path: ./run.log
          retention-days: 3

      # ----------------------------
      # Upload CSV file
      # ----------------------------
      - name: Upload CSV file
        uses: actions/upload-artifact@v4
        with:
          name: run-csv-${{ matrix.os }}
          path: ./run.csv
          retention-days: 3
 
 
