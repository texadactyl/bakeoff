name: Run bakeoff on MacOS and Ubuntu

on:
  workflow_dispatch:
  
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-24.04-arm, ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - uses: actions/checkout@v4

      # ---------------------------------------
      # Disable Windows Defender (Windows only)
      # ---------------------------------------
      - name: Disable Windows Defender (Windows only)
        if: startsWith(matrix.os, 'windows')
        shell: powershell
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true

      # ----------------------------
      # Install GCC (Windows only)
      # ----------------------------
      - name: Install GCC (MinGW) on Windows
        if: startsWith(matrix.os, 'windows')
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-binutils

      - name: Add MinGW to PATH (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: bash
        run: |
          echo "C:/msys64/mingw64/bin" >> $GITHUB_PATH

      # ----------------------------
      # Install D compiler (ldc2)
      # ----------------------------
      - name: Set up D (ldc2)
        uses: dlang-community/setup-dlang@v1
        with:
          compiler: ldc-latest

      # ----------------------------
      # Install Zig
      # ----------------------------
      - name: Set up Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0
          cache: false

      # ----------------------------
      # Install Go
      # ----------------------------
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24
          cache: false
 
      # ----------------------------
      # Setup Java per runner
      # ----------------------------
      # All except Windows ARM64
      - name: Setup JDK, not Windows ARM64
        if: matrix.os != 'windows-11-arm'
        uses: actions/setup-java@main
        with:
          distribution: 'oracle'
          java-version: '21'

      # Windows ARM64
      - name: Set up JDK on Windows ARM64
        if: matrix.os == 'windows-11-arm'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          architecture: 'arm64'

      # ----------------------------
      # Verify toolchains
      # ----------------------------
      - name: Verify Compilers
        shell: bash
        run: |
          echo "=== Compilers ==="
          echo "OS: $RUNNER_OS"
          echo "Arch: $(uname -m)"
          echo "GCC:"
          gcc --version | head -n 1 || echo "gcc not available"
          echo "LDC2:"
          ldc2 --version 2>&1 | grep -m1 "LDC" || echo "ldc2 not available"
          echo "Zig:"
          zig version
          echo "Go:"
          go version
          echo "Java:"
          java -version 2>&1 | head -n 1

      # ----------------------------
      # Run bash script: ga.sh
      # Generate: ga.log
      # ----------------------------
      - name: Run deterministic cross-language build
        shell: bash
        run: |
          chmod +x ./ga.sh
          LOGFILE=./ga.log ./ga.sh

      # ----------------------------
      # Upload normalized log
      # ----------------------------
      - name: Upload GA log
        uses: actions/upload-artifact@v4
        with:
          name: ga-log-${{ matrix.os }}
          path: ./ga.log
          retention-days: 3
